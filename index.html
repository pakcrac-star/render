<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Pakcrac Flower Renderer</title>
<style>
    body { margin:0; overflow:hidden; background:#131115; color:white; font-family:sans-serif; }
    #main { position:fixed; left:0; top:0; transform-origin:0 0; width:1024px; height:1024px; }
    canvas { display:block; width:100%; height:100%; }
    #ui { position:fixed; top:10px; left:10px; background:rgba(20,20,20,0.8); padding:10px; border-radius:8px; }
    #ui button, #ui select, #ui input { margin:4px; }
    #kernelArea { display:none; margin-top:8px; }
    #kernelArea textarea { width:300px; height:150px; }
    #infoBox { position:fixed; bottom:10px; left:10px; background:rgba(0,0,0,0.5); padding:6px 10px; border-radius:6px; font-size:14px; }
</style>
</head>
<body>

<div id="main">
    <canvas id="c1" width="1024" height="1024"></canvas>
</div>

<div id="ui">
    <button id="toggleKernel">Show Kernel</button>
    <button id="applyKernel">Apply Kernel</button>
    <button id="resetCamera">Reset Camera</button>
    <select id="renderMode">
        <option value="gpu">GPU Render</option>
        <option value="cpu">CPU Render</option>
    </select>
    <div>
        <label>Red: <input type="range" id="redSlider" min="0" max="1" step="0.01" value="0.276"></label>
        <label>Green: <input type="range" id="greenSlider" min="0" max="1" step="0.01" value="0.920"></label>
        <label>Blue: <input type="range" id="blueSlider" min="0" max="1" step="0.01" value="0.276"></label>
    </div>
    <div id="kernelArea">
        <textarea id="kernelText"></textarea>
    </div>
</div>

<div id="infoBox">Pakcrac Flower Renderer | Mode: GPU</div>

<script>
let canvas = document.getElementById('c1');
let cx, cy;
let ang1=2.8, ang2=0.4, cenx=0, ceny=0, cenz=0;
let len = 1.6;
let mx=0,my=0,ml=0,mr=0,mm=0;
let lastTouch=0;
let renderMode = "gpu";

// Default flower kernel
let KERNEL = `
float kernal(vec3 p){
    float r = length(p);
    float theta = atan(p.y,p.x);
    float phi = acos(p.z/r);
    float petals = 6.0;
    float k = cos(petals*theta)*sin(phi);
    float density = exp(-r*r*2.0)*k;
    return density;
}
`;

let infoBox = document.getElementById('infoBox');

function updateViewport(){
    cx = document.body.clientWidth;
    cy = document.body.clientHeight;
    document.getElementById('main').style.width="1024px";
    document.getElementById('main').style.height="1024px";
    document.getElementById('main').style.transform="scale("+cx/1024+","+cy/1024+")";
}
window.onresize=updateViewport;
updateViewport();

// Camera controls
document.addEventListener('mousedown',(e)=>{ if(e.button==0) ml=1; if(e.button==2) mr=1; mx=e.clientX; my=e.clientY; });
document.addEventListener('mouseup',(e)=>{ if(e.button==0) ml=0; if(e.button==2) mr=0; });
document.addEventListener('mousemove',(e)=>{
    if(ml){ ang1+=(e.clientX-mx)*0.002; ang2+=(e.clientY-my)*0.002; mm=1; }
    if(mr){
        let l=len*4/(cx+cy);
        cenx+=l*(-(e.clientX-mx)*Math.sin(ang1)-(e.clientY-my)*Math.sin(ang2)*Math.cos(ang1));
        ceny+=l*((e.clientY-my)*Math.cos(ang2));
        cenz+=l*((e.clientX-mx)*Math.cos(ang1)-(e.clientY-my)*Math.sin(ang2)*Math.sin(ang1));
        mm=1;
    }
    mx=e.clientX; my=e.clientY;
});
document.addEventListener('wheel',(e)=>{ e.preventDefault(); len *= Math.exp(-0.001*e.deltaY); },{passive:false});
document.addEventListener('touchstart',(e)=>{
    if(e.touches.length==1){ mx=e.touches[0].clientX; my=e.touches[0].clientY; }
    lastTouch=e.touches.length;
});
document.addEventListener('touchmove',(e)=>{
    e.preventDefault();
    if(e.touches.length==1&&lastTouch==1){ ang1+=(e.touches[0].clientX-mx)*0.002; ang2+=(e.touches[0].clientY-my)*0.002; mx=e.touches[0].clientX; my=e.touches[0].clientY; }
},{passive:false});

// GPU Shader
let gl = canvas.getContext('webgl');
if(!gl){ renderMode='cpu'; }

let VSHADER_SOURCE = `
attribute vec4 position;
varying vec3 dir;
uniform vec3 right, forward, up, origin;
uniform float x,y;
void main(){
    gl_Position = position;
    dir = forward + right*position.x*x + up*position.y*y;
}`;

let FSHADER_SOURCE = `
precision highp float;
varying vec3 dir;
uniform vec3 right, forward, up, origin;
uniform float len;
uniform float uColorR,uColorG,uColorB;
float kernal(vec3 p);
void main(){
    vec3 color = vec3(0.0);
    float step = 0.002;
    for(int i=0;i<200;i++){
        vec3 p = origin + dir*step*len*float(i);
        float d = kernal(p);
        color += vec3(uColorR,uColorG,uColorB)*d*0.05;
    }
    gl_FragColor = vec4(color,1.0);
}
`;

// Compile GPU shaders
function createShader(gl, type, source){ let s=gl.createShader(type); gl.shaderSource(s,source); gl.compileShader(s); return s; }
let shaderProgram = gl.createProgram();
let vertShader=createShader(gl, gl.VERTEX_SHADER, VSHADER_SOURCE);
let fragShader=createShader(gl, gl.FRAGMENT_SHADER, FSHADER_SOURCE+KERNEL);
gl.attachShader(shaderProgram, vertShader);
gl.attachShader(shaderProgram, fragShader);
gl.linkProgram(shaderProgram);
gl.useProgram(shaderProgram);

let glPos = gl.getAttribLocation(shaderProgram,'position');
let glRight = gl.getUniformLocation(shaderProgram,'right');
let glForward = gl.getUniformLocation(shaderProgram,'forward');
let glUp = gl.getUniformLocation(shaderProgram,'up');
let glOrigin = gl.getUniformLocation(shaderProgram,'origin');
let glX = gl.getUniformLocation(shaderProgram,'x');
let glY = gl.getUniformLocation(shaderProgram,'y');
let glLen = gl.getUniformLocation(shaderProgram,'len');
let uColorR = gl.getUniformLocation(shaderProgram,'uColorR');
let uColorG = gl.getUniformLocation(shaderProgram,'uColorG');
let uColorB = gl.getUniformLocation(shaderProgram,'uColorB');

let positions = [-1,-1,0, 1,-1,0, 1,1,0, -1,-1,0, 1,1,0, -1,1,0];
let buffer = gl.createBuffer(); gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(positions),gl.STATIC_DRAW);
gl.vertexAttribPointer(glPos,3,gl.FLOAT,false,0,0); gl.enableVertexAttribArray(glPos);

// Draw GPU
function drawGPU(){
    gl.viewport(0,0,1024,1024);
    gl.uniform1f(glX,cx*2/(cx+cy));
    gl.uniform1f(glY,cy*2/(cx+cy));
    gl.uniform1f(glLen,len);
    gl.uniform3f(glOrigin,len*Math.cos(ang1)*Math.cos(ang2)+cenx,len*Math.sin(ang2)+ceny,len*Math.sin(ang1)*Math.cos(ang2)+cenz);
    gl.uniform3f(glRight,Math.sin(ang1),0,-Math.cos(ang1));
    gl.uniform3f(glUp,-Math.sin(ang2)*Math.cos(ang1),Math.cos(ang2),-Math.sin(ang2)*Math.sin(ang1));
    gl.uniform3f(glForward,-Math.cos(ang1)*Math.cos(ang2),-Math.sin(ang2),-Math.sin(ang1)*Math.cos(ang2));
    gl.uniform1f(uColorR,document.getElementById('redSlider').value);
    gl.uniform1f(uColorG,document.getElementById('greenSlider').value);
    gl.uniform1f(uColorB,document.getElementById('blueSlider').value);
    gl.drawArrays(gl.TRIANGLES,0,6);
}

// CPU fallback
function drawCPU(){
    let ctx=canvas.getContext('2d');
    let img=ctx.createImageData(canvas.width,canvas.height);
    for(let y=0;y<canvas.height;y++){
        for(let x=0;x<canvas.width;x++){
            let i=(y*canvas.width+x)*4;
            let nx=(x-canvas.width/2)/256, ny=(y-canvas.height/2)/256;
            let r=Math.sqrt(nx*nx+ny*ny);
            let petals=Math.sin(r*12.0)*0.5+0.5;
            img.data[i]=document.getElementById('redSlider').value*255*petals;
            img.data[i+1]=document.getElementById('greenSlider').value*255*petals;
            img.data[i+2]=document.getElementById('blueSlider').value*255*petals;
            img.data[i+3]=255;
        }
    }
    ctx.putImageData(img,0,0);
}

// Animation loop
function animate(){
    if(renderMode==='gpu') drawGPU();
    else drawCPU();
    infoBox.innerText=`Pakcrac Flower Renderer | Mode: ${renderMode.toUpperCase()}`;
    requestAnimationFrame(animate);
}
animate();

// UI
document.getElementById('toggleKernel').addEventListener('click',()=>{
    let area=document.getElementById('kernelArea');
    area.style.display=(area.style.display==='none')?'block':'none';
    document.getElementById('kernelText').value=KERNEL;
});
document.getElementById('applyKernel').addEventListener('click',()=>{
    KERNEL=document.getElementById('kernelText').value;
    gl.shaderSource(fragShader,FSHADER_SOURCE+KERNEL); gl.compileShader(fragShader);
    gl.linkProgram(shaderProgram); gl.useProgram(shaderProgram);
});
document.getElementById('resetCamera').addEventListener('click',()=>{ ang1=2.8; ang2=0.4; cenx=0; ceny=0; cenz=0; len=1.6; });
document.getElementById('renderMode').addEventListener('change',(e)=>{ renderMode=e.target.value; });
</script>

</body>
</html>
